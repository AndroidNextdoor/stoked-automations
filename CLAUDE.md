# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Repository Overview

This is **the comprehensive marketplace and learning hub for Stoked Automations**. It serves as both a distribution platform for plugins and an educational resource for plugin developers.

**Repository Stats:**
- 231 total plugins across 15 categories
- 170 plugins with Agent Skills (automatic activation)
- 6 MCP server plugins (TypeScript/Node.js executables with 21 tools)
- Live marketplace at https://stokedautomations.com/
- Monorepo using pnpm workspaces

**Note:** Plugin counts are centrally managed in `.claude-plugin/stats.json`

## Critical Architecture Understanding

### Two Catalog System

This repository maintains **two separate catalog files**:

1. **`.claude-plugin/marketplace.extended.json`** (SOURCE OF TRUTH)
   - Full metadata including `featured`, `mcpTools`, `pricing`, `components`
   - Used by the Astro marketplace website
   - Edit this file when adding/updating plugins

2. **`.claude-plugin/marketplace.json`** (GENERATED FILE)
   - Sanitized version for Claude CLI compatibility
   - Auto-generated by `pnpm run sync-marketplace`
   - Contains only CLI-supported fields (strips extended metadata)
   - **NEVER edit this file directly**

### Catalog Sync Workflow

```bash
# After editing marketplace.extended.json:
pnpm run sync-marketplace  # Regenerates marketplace.json

# CI will fail if marketplace.json is out of sync
# Always run sync-marketplace before committing
```

The sync script (`scripts/sync-marketplace.cjs`) strips these fields: `featured`, `mcpTools`, `pluginCount`, `pricing`, `components`

### Monorepo Structure

This is a pnpm workspace with two separate package ecosystems:

```
claude-code-plugins/
├── plugins/mcp/                    # MCP plugins (TypeScript/Node.js)
│   ├── project-health-auditor/    # 4 MCP tools
│   ├── conversational-api-debugger/ # 4 MCP tools
│   ├── domain-memory-agent/       # 6 MCP tools
│   ├── design-to-code/            # 3 MCP tools
│   └── workflow-orchestrator/     # 4 MCP tools
├── marketplace/                    # Astro website (Node.js)
│   ├── src/                       # Astro 5.14.5 + Tailwind 4
│   ├── dist/                      # Built site
│   └── vercel.json                # Vercel deployment config
└── pnpm-workspace.yaml            # Workspace config
```

## Common Development Commands

### Catalog Management

```bash
# After editing marketplace.extended.json (ALWAYS RUN THIS):
pnpm run sync-marketplace

# Validate catalogs are in sync (CI check):
node scripts/sync-marketplace.cjs
git diff --quiet .claude-plugin/marketplace.json  # Should show no changes
```

### Validation & Testing

```bash
# Comprehensive validation (run before committing):
./scripts/validate-all.sh

# Validate specific plugin/directory:
./scripts/validate-all.sh plugins/mcp/project-health-auditor/

# Test plugin installation locally:
./scripts/test-installation.sh

# Check markdown frontmatter:
python3 scripts/check-frontmatter.py

# Validate specific JSON file:
jq empty path/to/file.json
```

### MCP Plugin Development

```bash
# Install dependencies for all MCP plugins:
pnpm install

# Build all MCP plugins:
pnpm build

# Build specific MCP plugin:
cd plugins/mcp/[plugin-name]/
pnpm build

# Run tests:
pnpm test  # All plugins
cd plugins/mcp/[plugin-name]/ && pnpm test  # Specific plugin

# Type checking:
pnpm typecheck
```

### Marketplace Website Development

```bash
cd marketplace/

# Development server (http://localhost:4321):
npm run dev

# Production build:
npm run build

# Preview production build:
npm run preview
```

### Mode Switching Scripts

```bash
# Enable PR review mode (optimized for code review):
scripts/modes/enable-pr-review-mode.sh

# Features:
# - Detects system resources and optimizes token limits
# - Higher thinking tokens for deep code analysis
# - Lower output tokens for concise review comments
# - Instructions for installing PR review plugins (code-review-ai)

# Enable 30-hour deep work mode (maximum token limits):
scripts/modes/enable-30-hour-mode.sh

# Features:
# - Maximum token limits for extended deep work sessions
# - Optimized for complex problem-solving (30+ hours)
# - Comprehensive toolkit of specialized agents
# - Ideal for full-stack development and large-scale refactoring

# Future modes:
# - enable-testing-mode.sh        - Browser testing tools
# - enable-documentation-mode.sh  - Documentation generation tools
```

### Local Plugin Testing Workflow

```bash
# 1. Create test marketplace structure:
mkdir -p ~/test-marketplace/.claude-plugin

# 2. Create marketplace.json pointing to local plugin:
cat > ~/test-marketplace/.claude-plugin/marketplace.json << 'EOF'
{
  "name": "test",
  "owner": {"name": "Test"},
  "plugins": [{
    "name": "my-plugin",
    "source": "/absolute/path/to/plugins/community/my-plugin"
  }]
}
EOF

# 3. Add test marketplace to Claude Code:
/plugin marketplace add ~/test-marketplace

# 4. Install and test:
/plugin install my-plugin@test
/my-command  # Test slash commands
```

## Adding a New Plugin

### Complete Workflow

1. **Create plugin structure:**
```bash
mkdir -p plugins/community/your-plugin/.claude-plugin
mkdir -p plugins/community/your-plugin/commands  # If using commands
mkdir -p plugins/community/your-plugin/agents    # If using agents
```

2. **Create required files:**
   - `.claude-plugin/plugin.json` (metadata with name, version, description, author)
   - `README.md` (comprehensive documentation with examples)
   - `LICENSE` (MIT or Apache-2.0 recommended)
   - At least one component directory

3. **Update marketplace.extended.json (SOURCE):**
```json
{
  "plugins": [
    {
      "name": "your-plugin",
      "source": "./plugins/community/your-plugin",
      "description": "Clear one-line description",
      "version": "2025.0.0",
      "category": "productivity",
      "keywords": ["keyword1", "keyword2"],
      "author": {
        "name": "Your Name",
        "email": "your.email@stokedautomations.com"
      }
    }
  ]
}
```

4. **Regenerate CLI catalog:**
```bash
pnpm run sync-marketplace
```

5. **Validate:**
```bash
./scripts/validate-all.sh plugins/community/your-plugin/
jq '.plugins[] | select(.name == "your-plugin")' .claude-plugin/marketplace.json
```

6. **Test locally** using the test marketplace workflow above

7. **Submit PR** using `.github/PULL_REQUEST_TEMPLATE.md`

## Plugin Architecture Details

### Plugin Types

**All Plugins (231 total):**
- Markdown-based instruction plugins (commands, agents)
- MCP server plugins (TypeScript/Node.js executables)
- Categories: api-development, ai-ml, security, devops, crypto, database, testing, performance, productivity, ai-agency, etc.

**Required frontmatter for commands/agents:**
```yaml
---
name: command-name
description: What this does
model: sonnet  # or opus, haiku
---
```

### MCP Server Plugins (6 plugins)

- TypeScript/Node.js applications
- Run as separate processes
- Build with `@modelcontextprotocol/sdk`
- Compiled to JavaScript in `dist/`
- Each provides 3-6 MCP tools

**Current MCP plugins:**
- `project-health-auditor` - Code health analysis (4 tools)
- `conversational-api-debugger` - REST API debugging (4 tools)
- `domain-memory-agent` - Knowledge base with semantic search (6 tools)
- `design-to-code` - Convert Figma/screenshots to code (3 tools)
- `workflow-orchestrator` - DAG-based automation (4 tools)
- `ai-experiment-logger` - ML experiment tracking

**MCP plugin structure:**
```
plugin-name/
├── src/
│   └── index.ts          # Main server implementation
├── dist/                 # Compiled JavaScript (gitignored)
├── package.json          # Node.js dependencies
├── tsconfig.json         # TypeScript config
└── .claude-plugin/
    ├── plugin.json       # Plugin metadata
    └── mcp/
        └── server.json   # MCP server configuration
```

## Critical Conventions

### Path Variables

Always use `${CLAUDE_PLUGIN_ROOT}` in hooks for portable paths:
```json
{
  "hooks": {
    "PostToolUse": {
      "command": "${CLAUDE_PLUGIN_ROOT}/scripts/process.sh"
    }
  }
}
```

### Script Permissions

All shell scripts MUST be executable (validated by CI):
```bash
chmod +x scripts/*.sh
find . -type f -name "*.sh" -exec chmod +x {} \;
```

### Plugin Categories

Valid categories: `productivity`, `security`, `testing`, `deployment`, `documentation`, `analysis`, `integration`, `ai`, `devops`, `debugging`, `code-quality`, `design`, `example`, `api-development`, `database`, `crypto`, `performance`, `ai-ml`, `ai-agency`, `skill-enhancers`, `finance`, `other`

**Category descriptions:**
- `ai-agency` - Automation platforms (n8n, Make, Zapier) and business tools
- `skill-enhancers` - Extend Claude's built-in Skills (web_search, web_fetch) with automation
- `finance` - Financial analysis and trading tools

### Versioning

This repository uses **Annual-style versioning** (`YYYY.MAJOR.MINOR`), inspired by the versioning scheme used by IntelliJ IDEA, PyCharm, and other Annual products.

**Format:** `YYYY.MAJOR.MINOR`

**Examples:**
- `2025.0.0` - Initial release in 2025
- `2025.1.0` - Major feature update (backward compatible)
- `2025.1.1` - Minor update or bug fix
- `2025.2.0` - Next major feature release
- `2026.0.0` - First release in 2026 (resets MAJOR to 0)

**Versioning Rules:**
1. **YYYY** - Calendar year (e.g., 2025, 2026)
   - Resets annually
   - Provides clear chronological context

2. **MAJOR** - Significant feature releases
   - Increments for major new features or improvements
   - Backward compatible within the same year
   - Resets to 0 at the start of each new year

3. **MINOR** - Bug fixes, patches, and minor improvements
   - Increments for bug fixes or small enhancements
   - Always backward compatible
   - No breaking changes

**When to Bump Versions:**
- **YYYY.MAJOR** - Major features, significant refactoring, new capabilities
- **YYYY.MINOR** - Bug fixes, documentation updates, small improvements

**Breaking Changes:**
- Avoid breaking changes within the same calendar year
- If breaking changes are absolutely necessary, document them clearly in CHANGELOG.md
- Consider deprecation warnings before removing features

**Benefits of Annual-Style Versioning:**
- Clear chronological context (know when a version was released)
- Predictable release cadence
- Easy to understand progression
- Works well with annual planning cycles
- Familiar to developers using Annual IDEs

**Migration from Semantic Versioning:**
All plugins have been migrated from `1.0.0` (semantic versioning) to `2025.0.0` (Annual-style) as of October 2025.

## CI/CD Pipeline

### GitHub Actions Workflows

1. **`.github/workflows/validate-plugins.yml`** (runs on PR and main push)
   - Validates marketplace.json is in sync with marketplace.extended.json
   - Checks JSON syntax with `jq`
   - Validates plugin structure (plugin.json, README.md, LICENSE)
   - Verifies script permissions (`chmod +x`)
   - Security scans:
     - Hardcoded secrets detection
     - AWS keys detection (blocks CI)
     - Private key detection (blocks CI)
     - Dangerous command patterns (`rm -rf /`)
     - Command injection risks (`eval()`)
     - Suspicious URLs (non-HTTPS, URL shorteners)
   - MCP plugin dependency audit (`npm audit`)

2. **`.github/workflows/deploy-marketplace.yml`** (deploys to Vercel)
   - Builds Astro site with Vercel CLI
   - Deploys to production: https://stokedautomations.com/
   - Requires `VERCEL_TOKEN` secret configured in GitHub

3. **`.github/workflows/release.yml`** (version tagging with Annual-style versioning)
   - Creates GitHub releases with changelog
   - Annual-style versioning (YYYY.MAJOR.MINOR)
   - Auto-resets version at new year

### Pre-commit Checklist

Before committing changes:

```bash
# 1. Sync catalogs if you edited marketplace.extended.json:
pnpm run sync-marketplace

# 2. Run full validation:
./scripts/validate-all.sh

# 3. Make scripts executable:
find . -type f -name "*.sh" -exec chmod +x {} \;

# 4. Validate JSON:
find . -name "*.json" -exec sh -c 'jq empty {}' \;

# 5. Check for secrets:
grep -r "password\|secret\|api_key" plugins/ | grep -v placeholder
```

## Common Issues & Troubleshooting

### Marketplace Sync Failures

**Error:** CI fails with "Marketplace CLI catalog was out of date"

**Solution:**
```bash
pnpm run sync-marketplace
git add .claude-plugin/marketplace.json
git commit --amend --no-edit
```

### Plugin Not Appearing

**Checklist:**
1. Valid `plugin.json` with required fields (name, version, description, author)
2. Entry exists in `marketplace.extended.json`
3. Ran `pnpm run sync-marketplace` after adding entry
4. Plugin source path is correct relative to repo root
5. At least one component directory exists (commands/, agents/, hooks/, mcp/, or scripts/)

### Scripts Not Executing

**Common causes:**
1. Missing execute permission → `chmod +x script.sh`
2. Wrong shebang → Should be `#!/bin/bash` or `#!/usr/bin/env bash`
3. Absolute path in hooks → Use `${CLAUDE_PLUGIN_ROOT}/scripts/script.sh`

### Hooks Not Firing

**Debugging steps:**
1. Validate `hooks.json` syntax with `jq`
2. Check matcher patterns match your use case
3. Verify script path uses `${CLAUDE_PLUGIN_ROOT}`
4. Test hook script independently

### MCP Plugin Build Failures

**Common issues:**
1. Missing dependencies → `pnpm install`
2. TypeScript errors → `pnpm typecheck`
3. Wrong Node version → Use Node.js 20+
4. Missing `@modelcontextprotocol/sdk` → Check package.json

## Security Requirements

1. **Never hardcode secrets** - Use environment variables or user prompts
2. **Validate all inputs** in scripts before executing commands
3. **Use `${CLAUDE_PLUGIN_ROOT}`** for all paths in hooks
4. **Request minimal permissions** - Don't ask for system-wide access
5. **No destructive operations** without explicit user confirmation
6. **All `.sh` files must be executable** - Enforced by CI
7. **No private keys or AWS keys** - Blocks CI immediately

## File Structure Requirements

### Required Files (Every Plugin)

```
plugin-name/
├── .claude-plugin/
│   └── plugin.json              # REQUIRED: name, version, description, author
├── README.md                     # REQUIRED: Documentation with examples
├── LICENSE                       # REQUIRED: MIT or Apache-2.0 recommended
└── [commands|agents|hooks|mcp|scripts]/  # At least one component
```

### plugin.json Schema

```json
{
  "name": "plugin-name",
  "version": "2025.0.0",
  "description": "Clear description",
  "author": {
    "name": "Author Name",
    "email": "author@stokedautomations.com"
  },
  "repository": "https://github.com/username/repo",
  "license": "MIT",
  "keywords": ["keyword1", "keyword2"]
}
```

### Command/Agent Markdown Format

```markdown
---
name: command-name
description: Brief description
model: sonnet
---

# Command Title

Detailed instructions for Claude...
```

### Agent Skills Format (NEW)

Agent Skills are placed in `skills/skill-adapter/SKILL.md`:

```markdown
---
name: Skill Name
description: |
  What this skill does and when it activates.
  Include trigger phrases users might say.
---

## How It Works
1. Step-by-step explanation of the skill's workflow

## When to Use This Skill
- Use case 1
- Use case 2

## Examples
User: "Example user request"
Skill activates → Expected outcome
```

**Key differences from commands:**
- Skills activate automatically based on context (no `/command` needed)
- Description should include trigger phrases
- Focus on teaching Claude WHEN and HOW to use the plugin
- One skill per plugin (comprehensive instruction manual)

### Hooks Format

```json
{
  "hooks": {
    "PostToolUse": {
      "matchers": [
        {
          "tools": ["Edit", "Write"],
          "filePatterns": ["**/*.py"]
        }
      ],
      "command": "${CLAUDE_PLUGIN_ROOT}/scripts/format.sh"
    }
  }
}
```

## Package Management

### pnpm Workspace Commands

```bash
# Install dependencies for all workspace packages:
pnpm install

# Run script in all packages:
pnpm --filter '*' build
pnpm --filter '*' test

# Run script in specific package:
pnpm --filter project-health-auditor build

# Add dependency to specific package:
cd plugins/mcp/plugin-name/
pnpm add dependency-name

# Update all dependencies:
pnpm update -r
```

## Marketplace Distribution

### Installation Commands

Users install plugins from this marketplace:

```bash
# Add marketplace (GitHub shorthand):
/plugin marketplace add AndroidNextdoor/stoked-automations

# Install plugins:
/plugin install plugin-name@stoked-automations
/plugin install devops-automation-pack@stoked-automations
/plugin install project-health-auditor@stoked-automations
```

### Marketplace Slug

- **Marketplace name:** `stoked-automations`
- **GitHub repo:** `AndroidNextdoor/stoked-automations`
- **Live site:** https://stokedautomations.com/

## Important Context

### NOT GitHub Marketplace

Stoked Automations use their own ecosystem with JSON-based marketplace catalogs. This repository IS a Claude Code plugin marketplace, not related to GitHub's marketplace for Actions/Apps.

### No Built-in Monetization

There is no monetization mechanism for Stoked Automations. All plugins are free and open-source. External revenue strategies exist (consulting, support, premium versions).

### Beta Status (October 2025)

Stoked Automations are in public beta. Features and best practices evolve. This marketplace stays updated with latest changes.

### Plugin Component Types

- **Commands & Agents:** Markdown instruction files that guide Claude's behavior (majority of 231 plugins)
- **MCP Servers:** TypeScript/Node.js executables running as separate processes (6 plugins)
- **Agent Skills:** Automatic activation based on conversation context (170 plugins have skills)

All types are valid and fully functional. Many plugins combine multiple components (e.g., commands + agent skills).

**Current stats:** See `.claude-plugin/stats.json` for accurate counts.

## Resources

### Official Documentation
- **Claude Code Docs:** https://docs.claude.com/en/docs/claude-code/
- **Plugin Guide:** https://docs.claude.com/en/docs/claude-code/plugins
- **Plugin Reference:** https://docs.claude.com/en/docs/claude-code/plugins-reference

### Community
- **Discord:** https://discord.com/invite/6PPFFzqPDZ (#claude-code channel)
- **GitHub Issues:** https://github.com/AndroidNextdoor/stoked-automations/issues
- **GitHub Discussions:** https://github.com/AndroidNextdoor/stoked-automations/discussions

### This Repository
- **CONTRIBUTING.md** - Submission guidelines
- **SECURITY.md** - Security policy and threat model
- **CODE_OF_CONDUCT.md** - Community standards
- **USER_SECURITY_GUIDE.md** - Safe plugin evaluation
- **MCP-SERVERS-STATUS.md** - MCP plugin configurations
- **CHANGELOG.md** - Version history

## Development Principles

When working in this repository:

1. **Always sync catalogs:** Run `pnpm run sync-marketplace` after editing `marketplace.extended.json`
2. **Validate before committing:** Run `./scripts/validate-all.sh`
3. **Test locally first:** Use test marketplace pattern to verify plugins work
4. **Executable scripts:** All `.sh` files need `chmod +x` (CI enforced)
5. **JSON validation:** Use `jq empty file.json` to validate syntax
6. **Frontmatter required:** All command/agent markdown files need YAML frontmatter
7. **Portable paths:** Always use `${CLAUDE_PLUGIN_ROOT}` in hooks
8. **Documentation first:** Every plugin needs comprehensive README.md
9. **Security conscious:** No hardcoded secrets, validate inputs, minimal permissions
10. **Two-catalog awareness:** Edit `.extended.json` (source), generate `.json` (CLI)

---

**Last Updated:** October 2025
**Repository Version:** 1.1.0 (231 plugins, 170 with Agent Skills)
**Status:** Active, accepting community contributions
**Stats Source:** `.claude-plugin/stats.json`
